<!--

/* This js doc browser is part of GEGL
 *
 * GEGL is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * GEGL is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with GEGL; if not, see <http://www.gnu.org/licenses/>.
 *
 * 2014 Øyvind Kolås.
 */

-->

<html>
  <head><title>GEGL Operation Reference</title></head>

  <style>
    body { font-size: 1.0em; font-family: Sans; margin:0; }
    #query { border:0;padding:0;margin:0; background: rgba(250,250,250,0.8); width: 100%;
      position: fixed; top:0;left:0; z-index: 1;
      font-size: 1.5em;
      padding-left: 0.75em;
    }
    #view { padding-top: 4em; margin-left: 1em; margin-right: 1em; }
    .categories {
      font-size: 0.8em;
      position: fixed;
      width: auto;
      top: 0; right: 0;
      padding-top: 0.25em;
      padding-right: 0.25em;
      z-index: 2;
     }
     .category { 
       display: inline-block;
       padding-left: 0.25em;
       padding-right: 0.25em;
       color: blue;
       cursor: hand;
     }

     .view-source { 
       display: inline-block;
       padding-left: 0.25em;
       padding-right: 0.25em;
       color: blue;
       cursor: hand;
     }
     .category:hover { background: black; color: white; }

     .res_category { 
       display: inline-block;
       padding-left: 0.25em;
       padding-right: 0.25em;
       color: blue;
       cursor: hand;
     }
     .res_category:hover { background: black; color: white; }

    .op-image { margin: 1em; margin-top: 0em; margin-left: 0em; float: left }
    .properties {margin-top: 1em; clear: left; }
    .property { margin-top: 1em; margin-right: 2em; clear: both;
       padding-top: 1em;
    }
    .property>div { }

    .property>.property-label {
        display: block;
        float: none;
        font-size: 1.4em;
        min-width: 10em;
      }

    .key {
      -webkit-opacity: 0.5; -moz-opacity: 0.5; opacity: 0.5 ;
      font-size: 60%;
      min-width: 7em;
      display: inline-block;
      vertical-align: text-bottom;
      float :left;
      clear: left;
      padding-top: 0.25em;
    }
    .value {
      font-size: 80%;
      display: inline-block;
      float :left;
      padding-right: 1em;
    }

    .property-description {
      clear: left;
      padding-top: 0.5em;
    }

    .property>div.property-meta {
      float: right;
      min-width: 11em;
      padding-left: 1em;
      clear: right;
    }

    .opname  { font-weight: bold; margin-bottom: 0.2em; display: none; }
    .optitle { margin-bottom: 0.2em; 
    
               font-size: 1.4em;
    }

    .description { margin-bottom: 1em;}
    .result       { border: 2px solid transparent; }
    .result:hover { border: 2px solid black; background : #555; color :
      blue; cursor: hand; }
    .small .result     { display: inline-block; width: 150px; height: 150px;
      overflow: clip; }
    .small .result>img { margin-right:0.2em;min-width: 150px; height: 150px; }
    .small .result>div { display: inline-block;  position: relative; background:
      rgba(255,255,255, 0.8); padding-right: 0.4em; height: 1em;
      overflow:hidden;
      font-size: 0.75em;
      top: -1.0em; }
    .result { vertical-align: top; }
    .big .result     { display: inline-block; width: 200px; height: 200px;
      overflow: clip; }
    .big .result>img { margin-right:0.2em;min-width: 200px; height: 200px; }
    .big .result>div { display: inline-block;  position: relative; background:
      rgba(255,255,255, 0.8); padding-right: 0.4em; height: 1em;
      overflow:hidden;
      top: -1.0em; }
    .big>.result.text { height: 2em; }
    .small>.result.text { height: 2em; }
    .result.text>div { position:relative; top: 0.4em;}
  </style>

  <script src='operations.json'>
  </script>

  <script>

function id(idi) { return document.getElementById(idi) }
function show_op(op)
{
  id('view').innerHTML = window.opdb[0].op;
}

function filter_db(query)
{
  var opdb = window.opdb;
  var result = [];
  var uquery = query.toUpperCase ();

  var command = query.split(' ');
  if (command.length > 1)
    {
      var arg;
      command = command[0];
      arg = query.slice(command.length + 1);

      if (command == 'operation')
      {
        for (var i = 0; i < opdb.length; i++)
        {
          if (opdb[i].op == arg)
            return [opdb[i]];
        }
      }

      if (command == 'category')
      {
        for (var i = 0; i < opdb.length; i++)
        {
          var categories = opdb[i].categories;
          for (var j = 0; j < categories.length; j++)
          {
            if (categories[j] == arg)
            {
              result.push (opdb[i]);
              break;
            }
          }
        }
        return result;
      }


    }

  for (var i = 0; i < opdb.length; i++)
  {
    var op = opdb[i];
    var score = 0;
    var uop_name = op.op.toUpperCase ();

    /* ad-hoc opencl query */
    if (query == 'opencl' && op['opencl-support'])
      score += 20;

    if (opdb[i].parent == query) score += 100;

    if (op.op.indexOf(query) == 0)           score += 1000;
    if (op.op.slice(5).indexOf(query) == 0)  score += 900;
    if (op.op.indexOf(query) > 0)            score += 500;

    if (op.meta) {
      var got_title = false;
      for (var j = 0; j < op.meta.length; j++)
      {
        if (op.meta[j][0] == "title"  && query=="notitle")
          got_title = true;
        if (op.meta[j][1].indexOf(query) == 0) score += 100;
        if (op.meta[j][1].toUpperCase().indexOf(uquery) == 0) score += 100;
        if (op.meta[j][1].indexOf(query) >= 0) score += 10;
        if (op.meta[j][1].toUpperCase().indexOf(uquery) >= 0) score += 10;
      }
      if (query == 'notitle' && got_title == false)
        score += 2;
      }
    else
      if (query == 'notitle')
        score += 2;

    if (op.description &&
        op.description.indexOf(query) >= 0)  score += 10;

    if (uop_name.indexOf(uquery) == 0)           score += 1000;
    if (uop_name.slice(5).indexOf(uquery) == 0)  score += 900;
    if (uop_name.indexOf(uquery) > 0)            score += 500;

    if (op.description &&
        op.description.toUpperCase().indexOf(uquery) >= 0)  score += 10;

      {
        if (op.categories)
        for (var j = 0; j < op.categories.length; j++)
        {
          if (op.categories[j].indexOf(query) >= 0)
          {
            score += 30;
            break;
          }
        }
      }

    if (op.image == undefined)
    {
      /* make image-less ones rise to(wards) top */
      score *= 2;
    }

    if (score > 0)
    {
      /* var o = JSON.parse(JSON.stringify(opdb[i])); */ /* we only have one
      set of results,. so updating score in-place */
        op.score = score;
        result.push (op);
      }
  }

  result = result.sort(function(a,b){
    if (a.score != b.score)
      return (b.score - a.score);
    return a.op > b.op;
  });
  return result;
}

var initialized = false;
var previous_content = "";

function render_properties(properties)
{
  var result = ''
  result += '<div class="properties">'
   for (var i = 0; i < properties.length ; i++)
     {
       var prop = properties[i];
       result += '<div class="property">';
       result += "<div class='property-meta'>";

       for (var key in prop)
       {
         if (prop.hasOwnProperty(key) && key != 'name' 
                                      && key != 'label'
                                      && key != 'type'
                                      && key != 'description'
                                      && key != 'default')
           result += '<div><div class="key">' + key + '</div><div class="value">' + prop[key] + '</div></div>';
       }
       result += "</div>";

       result += '<div class="property-label">' + prop.label + ' </div>';
       result += '<div style="float:left"><div class="key">name</div><div class="value">' + prop.name + '</div></div>';
       result += '<div style="float:left"><div class="key">type</div><div class="value">' + prop.type + '</div></div>';

       if (prop.default)
         result += '<div style="float:left"><div class="key">default</div><div class="value">' + prop.default + '</div></div>';

       if (prop.description)
         result += '<div class="property-description">' + prop.description + ' </div>';

     result += '</div>'
   }
   result += '</div>'
   return result;
}

function render_item (item)
{
  var result = '';
  result += '<div class="categories">';


  if (item.categories)
  {
    for (var i = 0; i < item.categories.length; i ++)
    {
      result += '<div class="category" ' + "onclick='go(\"category "+item.categories[i]+"\")'" + '>' + item.categories[i] + '</div>';
    }
    result += '<div class="category" '+"onclick='go(\""+item.parent+"\")'" + '>' + item.parent.slice(13) + '</div>';

  if (item['opencl-support'])
    result += '<div class="category" '+"onclick=\"go('opencl')\"" + '>CL</div>';

   if (item.source)
     result += '<div class="view-source"><a href="' + item.source+ '#n18">View source</a></div>';
   result += '</div>';

  if (item.image)
    result += ' <img class="op-image" src="' + item.image + '" / >';

    result += '<div class="opname">' + item.op + '</div>';

  if (item.title)
    result += '<div class="optitle">' + item.title + '</div>';

  result += '<div class="description">' + item.description +
    '</div>';

  if (item['input-pads'])
  {
  result += '<div><div class="key">inputs&nbsp;</div><div class="value">';
    for (var i = 0; i < item['input-pads'].length; i++)
    {
      result += item['input-pads'][i];
    }
    result += '</div></div>';
  }
  if (item['output-pads'])
  {
  result += '<div><div class="key">outputs&nbsp;</div><div class="value">';
    for (var i = 0; i < item['output-pads'].length; i++)
      result += item['output-pads'][i];
      result += '</div></div>';
  }

    if (item.properties)
      result += render_properties (item.properties);

    result += '<div style="clear:all">&nbsp;</div>';
    result += '<div style="margin-top:4em;"></div>';
  }

  return result;
}

function go (query)
{
  window.location.hash=encodeURIComponent (id('query').value);
  window.location.hash=encodeURIComponent (query);
  id("query").value=query;
  show_matches();
}

function render_list2 (items, maxitems)
{
  var result = '';
  for (var i = 0; i < items.length && i < maxitems; i++)
  {
    var item = items[i];

    if (items[i].image)
    {
      result += "<div class='result' onclick='go(\"operation "+item.op+"\")' >";
      result += ' <img src="' + items[i].image + '"/>';
      result += '<div class="title">' + item.op + '</div>';
      result += '</div>';
    }
    else
    {
      result += "<div class='result text' onclick='go(\"operation "+item.op+"\")' >";
      result += '<div class="title">' + item.op + '</div>';
      result += '</div>';
    }

  }
  return result;
}

function render_all ()
{
  var result = '';
  var items = window.opdb;
  for (var i = 0; i < items.length; i++)
  {
    result += '<div style="font-weight:bold;font-size:1.5em;margin-top:1em;margin-bottom:1em;">' + items[i].op +'</div>';
    result += render_item (items[i]);
  }
  return result;
}

function render_list_big (items)
{
  return '<div class="big">' + render_list2 (items, 23) + '</div>';
}

function render_list_small (items)
{
  return '<div class="small">' + render_list2 (items, 142) + '</div>';
}

function render_categories ()
{
  var result = '';

  var cats = [];
  var opdb = window.opdb;

  for (var i = 0; i < opdb.length; i++)
  {
      if (opdb[i].categories)
      for (var j = 0; j < opdb[i].categories.length; j++)
      {
        var found = false;
        for (var k = 0; k < cats.length; k++)
        if (cats[k] == opdb[i].categories[j])
          found = true;
        if (!found)
          cats.push(opdb[i].categories[j]);
      }
  }

  cats = cats.sort();

  for (var i = 0; i < cats.length; i++)
  {
  result += '<div class="res_category" style="font-size: 150%;"'
    + "onclick='go(\"category "+cats[i]+"\")'>" 
    + cats[i] + '</div>';
  }


  return result;
}

window.onhashchange = function ()
{
  id('query').value = decodeURIComponent (window.location.hash.slice(1));
  show_matches ();
}


function show_matches(e)
{
  var items;
  var result = '';

  if (e && e.keyCode == 13)
  {
    window.location.hash= encodeURIComponent (id('query').value);
  }

  if (!initialized)
  {
    if (id('query').value == '')
    id('query').value = decodeURIComponent (window.location.hash.slice(1));
    initialized = true;
  }

  items = filter_db(id('query').value);

  if (id('query').value == 'list of all ops')
  {
    result += render_all ();
  }
  else if (id('query').value == '')
  {
    result += render_categories ();
  }
  else if (items.length == 0)
  {
    result = 'eek';
  }
  else if (items.length == 1)
  {
    if (items[0].op == id('query').value ||
    id('query').value.indexOf('op')==0)
    result += render_item (items[0]);
    else
    result += render_list_big (items);
  }
  else if (items.length < 23)
  {
    result += render_list_big (items);
  }
  else
    result += render_list_small (items);


  if (result != previous_content)
  {
    id('view').innerHTML = result;
    previous_content = result;
  }
}

  </script>

  <body>
    <input id='query' value='' placeholder="type to search"
    onkeyup='show_matches(event);'
    onactivate='setloc()'
     autocomplete='off'></input>
     <div id='view'>foo</div>
  </body>

  <script>
    show_matches();
    id('query').focus();
  </script>
</html>
